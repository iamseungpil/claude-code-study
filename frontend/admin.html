<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Claude Code Study</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { outfit: ['Outfit', 'sans-serif'] },
                    colors: {
                        dark: { 900: '#0a0a0f', 800: '#12121a', 700: '#1a1a25', 600: '#252530' },
                        accent: { blue: '#4f8cff', purple: '#a78bfa', amber: '#fbbf24', emerald: '#34d399', rose: '#fb7185' }
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Outfit', sans-serif; }
        .hero-gradient {
            background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(251, 113, 133, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse 60% 40% at 80% 60%, rgba(167, 139, 250, 0.1) 0%, transparent 40%),
                        #0a0a0f;
        }
        .nav-blur {
            background: rgba(10, 10, 15, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .week-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid rgba(255,255,255,0.06);
            transition: all 0.3s ease;
        }
        .week-card:hover {
            border-color: rgba(255,255,255,0.15);
        }
    </style>
</head>
<body class="bg-dark-900 text-white min-h-screen">
    <!-- Navigation -->
    <nav class="fixed top-0 w-full nav-blur border-b border-white/5 z-50">
        <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
            <a href="/" class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-accent-rose to-accent-purple flex items-center justify-center text-lg">üõ°Ô∏è</div>
                <span class="font-bold text-lg tracking-tight">Admin Panel</span>
            </a>
            <div class="flex items-center gap-3">
                <a href="/" class="text-sm text-gray-400 hover:text-white transition-colors">‚Üê Back to Main</a>
                <div id="user-profile" class="hidden flex items-center gap-2 bg-white/5 border border-white/10 px-3 py-2 rounded-xl">
                    <span id="user-name" class="text-sm font-medium"></span>
                    <span class="text-xs text-accent-rose font-bold">ADMIN</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="hero-gradient pt-28 pb-12 px-6 min-h-screen">
        <div class="max-w-4xl mx-auto">
            <!-- Access Denied Message (shown to non-admins) -->
            <div id="access-denied" class="hidden text-center py-20">
                <div class="text-6xl mb-6">üö´</div>
                <h1 class="text-3xl font-bold mb-4 text-rose-400">Access Denied</h1>
                <p class="text-gray-400 mb-8">This page is only accessible to administrators.</p>
                <a href="/" class="bg-accent-blue hover:bg-accent-blue/80 text-white font-bold py-3 px-6 rounded-xl transition-all">
                    Go to Main Page
                </a>
            </div>

            <!-- Login Required Message -->
            <div id="login-required" class="hidden text-center py-20">
                <div class="text-6xl mb-6">üîê</div>
                <h1 class="text-3xl font-bold mb-4">Login Required</h1>
                <p class="text-gray-400 mb-8">Please login to access the admin panel.</p>
                <a href="/" class="bg-accent-blue hover:bg-accent-blue/80 text-white font-bold py-3 px-6 rounded-xl transition-all">
                    Go to Login
                </a>
            </div>

            <!-- Admin Panel (shown to admins only) -->
            <div id="admin-panel" class="hidden">
                <div class="text-center mb-12">
                    <h1 class="text-4xl font-bold mb-4">Challenge Control Panel</h1>
                    <p class="text-gray-400">Manage weekly challenges for all participants</p>
                </div>

                <!-- Week Cards -->
                <div class="space-y-4" id="weeks-container">
                    <!-- Week cards will be dynamically generated -->
                </div>

                <!-- Registered Users Section -->
                <div class="mt-12 bg-dark-700/30 border border-white/10 rounded-3xl p-8">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-3">
                        <span class="text-2xl">üë•</span> Registered Users
                        <span id="users-count" class="text-sm font-normal text-gray-400">(0)</span>
                    </h2>
                    <div id="users-list" class="space-y-3">
                        <div class="text-center text-gray-500 py-4">Loading users...</div>
                    </div>
                </div>

                <!-- Current Submissions Section -->
                <div class="mt-8 bg-dark-700/30 border border-white/10 rounded-3xl p-8">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-3">
                        <span class="text-2xl">üìä</span> Recent Submissions
                    </h2>
                    <div id="submissions-list" class="space-y-3">
                        <div class="text-center text-gray-500 py-4">Loading submissions...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="config.js"></script>
    <script>
        const API_BASE = window.API_BASE || '';
        let currentUser = null;
        let challengesStatus = {};

        // Sanitize HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        const WEEK_TIME_LIMITS = {
            1: 45, 2: 50, 3: 60, 4: 60, 5: 75
        };

        const WEEK_NAMES = {
            1: 'Project Cleanup',
            2: 'CLI Tool + Auto Linting',
            3: 'Paper Survey',
            4: 'Bot or App MVP',
            5: 'Final Project'
        };

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        async function checkAuth() {
            const token = localStorage.getItem('auth_token');
            console.log('[Admin] Checking auth, token exists:', !!token);

            if (!token) {
                console.log('[Admin] No token found, showing login required');
                showLoginRequired();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                console.log('[Admin] API response status:', response.status);

                if (response.ok) {
                    currentUser = await response.json();
                    console.log('[Admin] Current user:', currentUser);
                    console.log('[Admin] User role:', currentUser.role);

                    if (currentUser.role !== 'admin') {
                        console.log('[Admin] User is not admin, showing access denied');
                        showAccessDenied();
                        return;
                    }

                    console.log('[Admin] User is admin, showing admin panel');
                    document.getElementById('user-name').textContent = currentUser.full_name;
                    document.getElementById('user-profile').classList.remove('hidden');
                    showAdminPanel();
                } else {
                    const errorText = await response.text();
                    console.log('[Admin] Auth failed:', response.status, errorText);
                    localStorage.removeItem('auth_token');
                    showLoginRequired();
                }
            } catch (e) {
                console.error('[Admin] Auth check failed:', e);
                showLoginRequired();
            }
        }

        function showLoginRequired() {
            document.getElementById('login-required').classList.remove('hidden');
            document.getElementById('access-denied').classList.add('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
        }

        function showAccessDenied() {
            document.getElementById('access-denied').classList.remove('hidden');
            document.getElementById('login-required').classList.add('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
        }

        function showAdminPanel() {
            document.getElementById('admin-panel').classList.remove('hidden');
            document.getElementById('login-required').classList.add('hidden');
            document.getElementById('access-denied').classList.add('hidden');
            loadChallengesStatus();
            loadUsers();
            loadRecentSubmissions();
        }

        async function loadUsers() {
            const token = localStorage.getItem('auth_token');
            try {
                const response = await fetch(`${API_BASE}/api/admin/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const users = await response.json();
                    renderUserList(users);
                }
            } catch (e) {
                console.error('Failed to load users:', e);
            }
        }

        function renderUserList(users) {
            const container = document.getElementById('users-list');
            const countEl = document.getElementById('users-count');
            countEl.textContent = `(${users.length})`;

            if (users.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">No registered users yet.</div>';
                return;
            }

            container.innerHTML = users.map(user => `
                <div class="flex items-center justify-between p-4 bg-dark-800/50 rounded-xl border border-white/5">
                    <div class="flex items-center gap-4">
                        ${user.profile_image
                            ? `<img src="${user.profile_image}" class="w-10 h-10 rounded-full object-cover">`
                            : `<div class="w-10 h-10 rounded-full bg-accent-purple/30 flex items-center justify-center text-lg font-bold">${user.first_name ? user.first_name.charAt(0).toUpperCase() : '?'}</div>`
                        }
                        <div>
                            <div class="font-medium">${escapeHtml(user.full_name || user.user_id)}</div>
                            <div class="text-sm text-gray-500">@${escapeHtml(user.user_id)} ${user.role === 'admin' ? '<span class="text-accent-rose">‚Ä¢ Admin</span>' : ''}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-gray-500">${user.registered_at ? new Date(user.registered_at).toLocaleDateString() : ''}</div>
                        ${user.role !== 'admin' ? `
                            <button onclick="deleteUser('${user.user_id}')" class="text-rose-400 hover:text-rose-300 transition-colors text-sm px-3 py-1 rounded-lg border border-rose-400/30 hover:bg-rose-400/10">
                                Delete
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function deleteUser(userId) {
            if (!confirm(`Are you sure you want to delete user "${userId}"?`)) {
                return;
            }

            const token = localStorage.getItem('auth_token');
            try {
                const response = await fetch(`${API_BASE}/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    loadUsers(); // Refresh the list
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to delete user');
                }
            } catch (e) {
                console.error('Failed to delete user:', e);
                alert('Failed to delete user');
            }
        }

        async function loadChallengesStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/challenges/status`);
                if (response.ok) {
                    challengesStatus = await response.json();
                    renderWeekCards();
                }
            } catch (e) {
                console.error('Failed to load challenges status:', e);
            }
        }

        function renderWeekCards() {
            const container = document.getElementById('weeks-container');
            container.innerHTML = '';

            for (let week = 1; week <= 5; week++) {
                const weekKey = `week${week}`;
                const challenge = challengesStatus[weekKey] || { status: 'not_started' };
                
                const colors = {
                    1: 'accent-blue',
                    2: 'accent-purple',
                    3: 'accent-amber',
                    4: 'accent-emerald',
                    5: 'accent-rose'
                };
                const color = colors[week];

                let statusBadge = '';
                let buttons = '';
                let timerDisplay = '';

                if (challenge.status === 'not_started') {
                    statusBadge = `<span class="text-xs font-bold px-2 py-1 rounded-full bg-gray-700 text-gray-400">Not Started</span>`;
                    buttons = `
                        <button onclick="startChallenge(${week})" class="bg-accent-emerald hover:bg-accent-emerald/80 text-dark-900 font-bold py-2 px-4 rounded-xl transition-all flex items-center gap-2">
                            <span>‚ñ∂Ô∏è</span> Start Challenge
                        </button>
                    `;
                } else if (challenge.status === 'started') {
                    statusBadge = `<span class="text-xs font-bold px-2 py-1 rounded-full bg-accent-emerald/20 text-accent-emerald animate-pulse">LIVE</span>`;
                    timerDisplay = `
                        <div class="mt-4 bg-dark-800/50 rounded-xl p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm text-gray-400">Elapsed Time</div>
                                    <div id="timer-week${week}" class="text-2xl font-bold text-${color} font-mono">00:00:00</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-400">Started</div>
                                    <div class="text-sm text-gray-300">${new Date(challenge.start_time).toLocaleString('en-US')}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    buttons = `
                        <button onclick="endChallenge(${week})" class="bg-accent-rose hover:bg-accent-rose/80 text-white font-bold py-2 px-4 rounded-xl transition-all flex items-center gap-2">
                            <span>‚èπÔ∏è</span> End Challenge
                        </button>
                    `;
                } else if (challenge.status === 'ended') {
                    statusBadge = `<span class="text-xs font-bold px-2 py-1 rounded-full bg-gray-600 text-gray-300">Ended</span>`;
                    timerDisplay = `
                        <div class="mt-4 bg-dark-800/50 rounded-xl p-4 opacity-60">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm text-gray-400">Duration</div>
                                    <div class="text-lg text-gray-300">${challenge.start_time && challenge.end_time ?
                                        formatTime(Math.floor((new Date(challenge.end_time) - new Date(challenge.start_time)) / 1000)) :
                                        '-'}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-400">Ended</div>
                                    <div class="text-sm text-gray-300">${challenge.end_time ? new Date(challenge.end_time).toLocaleString('en-US') : '-'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    buttons = `
                        <button onclick="restartChallenge(${week})" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition-all flex items-center gap-2">
                            <span>üîÑ</span> Restart (Clear All Data)
                        </button>
                    `;
                }

                const card = `
                    <div class="week-card rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-xl bg-${color}/20 border border-${color}/30 flex items-center justify-center text-xl font-bold text-${color}">
                                    ${week}
                                </div>
                                <div>
                                    <div class="text-sm text-gray-400">Week ${week}</div>
                                    <div class="text-lg font-bold">${WEEK_NAMES[week]}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                ${statusBadge}
                                <span class="text-sm text-gray-500">${WEEK_TIME_LIMITS[week]}min limit</span>
                            </div>
                        </div>
                        ${timerDisplay}
                        <div class="mt-4 flex justify-end">
                            ${buttons}
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            }

            // Update live timers
            updateLiveTimers();
        }

        function updateLiveTimers() {
            for (let week = 1; week <= 5; week++) {
                const weekKey = `week${week}`;
                const challenge = challengesStatus[weekKey];
                
                if (challenge && challenge.status === 'started') {
                    const timerEl = document.getElementById(`timer-week${week}`);
                    if (timerEl) {
                        const startTime = new Date(challenge.start_time).getTime();
                        const elapsed = Math.floor((Date.now() - startTime) / 1000);
                        timerEl.textContent = formatTime(elapsed);
                    }
                }
            }
        }

        async function startChallenge(week) {
            if (!confirm(`Start Week ${week} challenge for all participants?`)) return;

            const token = localStorage.getItem('auth_token');
            try {
                const response = await fetch(`${API_BASE}/api/admin/challenge/${week}/start`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(`Week ${week} challenge started at ${new Date(data.start_time).toLocaleString('en-US')}`);
                    loadChallengesStatus();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                }
            } catch (e) {
                alert('Connection error');
            }
        }

        async function endChallenge(week) {
            if (!confirm(`End Week ${week} challenge? No more submissions will be allowed.`)) return;

            const token = localStorage.getItem('auth_token');
            try {
                const response = await fetch(`${API_BASE}/api/admin/challenge/${week}/end`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert(`Week ${week} challenge ended.`);
                    loadChallengesStatus();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                }
            } catch (e) {
                alert('Connection error');
            }
        }

        async function restartChallenge(week) {
            // Require user to type DELETE to confirm
            const confirmation = prompt(
                `‚ö†Ô∏è WARNING: This will DELETE all submissions and evaluations for Week ${week}.\n\n` +
                `This action cannot be undone!\n\n` +
                `Type "DELETE" to confirm:`
            );

            if (confirmation !== 'DELETE') {
                alert('Restart cancelled. You must type "DELETE" exactly to confirm.');
                return;
            }

            const token = localStorage.getItem('auth_token');
            try {
                const response = await fetch(`${API_BASE}/api/admin/challenge/${week}/restart`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(`Week ${week} has been reset!\n\n` +
                          `Deleted ${data.deleted_submissions} submissions\n` +
                          `Deleted ${data.deleted_evaluations} evaluations\n\n` +
                          `Challenge is now ready to start again.`);
                    loadChallengesStatus();
                    loadRecentSubmissions();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                }
            } catch (e) {
                alert('Connection error');
            }
        }

        async function loadRecentSubmissions() {
            const container = document.getElementById('submissions-list');
            let allSubmissions = [];

            try {
                for (let week = 1; week <= 5; week++) {
                    const response = await fetch(`${API_BASE}/api/submissions/${week}`);
                    if (response.ok) {
                        const submissions = await response.json();
                        submissions.forEach(s => {
                            s.week = week;
                            allSubmissions.push(s);
                        });
                    }
                }

                // Sort by submitted_at descending
                allSubmissions.sort((a, b) => new Date(b.submitted_at || 0) - new Date(a.submitted_at || 0));
                
                // Show last 10
                const recent = allSubmissions.slice(0, 10);

                if (recent.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-4">No submissions yet</div>';
                    return;
                }

                container.innerHTML = recent.map(s => `
                    <div class="flex items-center justify-between bg-dark-800/50 rounded-xl p-4">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-lg bg-accent-blue/20 flex items-center justify-center text-sm font-bold">
                                W${s.week}
                            </div>
                            <div>
                                <div class="font-medium">${s.participant_id}</div>
                                <div class="text-sm text-gray-500">${s.submitted_at ? new Date(s.submitted_at).toLocaleString('en-US') : '-'}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-400">${s.elapsed_minutes ? s.elapsed_minutes.toFixed(1) + ' min' : '-'}</div>
                            <div class="text-xs text-gray-500">${s.status}</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">Failed to load submissions</div>';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            // Update timers every second
            setInterval(updateLiveTimers, 1000);
            // Reload status every 10 seconds
            setInterval(() => {
                if (currentUser && currentUser.role === 'admin') {
                    loadChallengesStatus();
                    loadRecentSubmissions();
                }
            }, 10000);
        });
    </script>
</body>
</html>
