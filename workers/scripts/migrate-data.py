#!/usr/bin/env python3
"""
One-time data migration: read local JSON/DB files â†’ generate SQL for D1.

Usage:
    cd claude-code-study
    python workers/scripts/migrate-data.py > workers/migrations/0002_data.sql
    cd workers
    wrangler d1 execute claude-study-db --file=migrations/0002_data.sql
"""

import json
import os
import sys
from pathlib import Path

BASE = Path(__file__).resolve().parent.parent.parent  # claude-code-study/

def esc(s):
    """Escape single quotes for SQL."""
    if s is None:
        return "NULL"
    return "'" + str(s).replace("'", "''") + "'"

def main():
    lines = []
    lines.append("-- Auto-generated data migration")
    lines.append("-- Generated by workers/scripts/migrate-data.py")
    lines.append("")

    # ===== 1. Users =====
    users_file = BASE / "data" / "users.json"
    if users_file.exists():
        with open(users_file, encoding="utf-8") as f:
            data = json.load(f)
        lines.append("-- Users")
        for u in data.get("users", []):
            uid = esc(u.get("user_id"))
            fn = esc(u.get("full_name"))
            first = esc(u.get("first_name"))
            last = esc(u.get("last_name"))
            pw = esc(u.get("password_hash"))
            img = esc(u.get("profile_image"))
            role = esc(u.get("role", "participant"))
            reg = esc(u.get("registered_at"))
            lines.append(
                f"INSERT OR IGNORE INTO users (user_id, full_name, first_name, last_name, password_hash, profile_image, role, registered_at) "
                f"VALUES ({uid}, {fn}, {first}, {last}, {pw}, {img}, {role}, {reg});"
            )
        lines.append("")

    # ===== 2. Challenges + Personal Timers =====
    challenges_file = BASE / "data" / "challenges.json"
    if challenges_file.exists():
        with open(challenges_file, encoding="utf-8") as f:
            data = json.load(f)
        lines.append("-- Challenges")
        for week_key in sorted(data.keys()):
            ch = data[week_key]
            week_num = int(week_key.replace("week", ""))
            status = esc(ch.get("status", "not_started"))
            start = esc(ch.get("start_time"))
            end = esc(ch.get("end_time"))
            by = esc(ch.get("started_by"))
            lines.append(
                f"UPDATE challenges SET status = {status}, start_time = {start}, end_time = {end}, started_by = {by} "
                f"WHERE week = {week_num};"
            )

            # Personal timers
            personal = ch.get("personal_starts", {})
            for uid, info in personal.items():
                started_at = esc(info.get("started_at"))
                timer_status = esc(info.get("status", "in_progress"))
                lines.append(
                    f"INSERT OR IGNORE INTO personal_timers (user_id, week, started_at, status) "
                    f"VALUES ({esc(uid)}, {week_num}, {started_at}, {timer_status});"
                )
        lines.append("")

    # ===== 3. Submissions =====
    submissions_dir = BASE / "submissions"
    if submissions_dir.exists():
        lines.append("-- Submissions")
        for week_dir in sorted(submissions_dir.iterdir()):
            if not week_dir.is_dir() or not week_dir.name.startswith("week"):
                continue
            week_num = int(week_dir.name.replace("week", ""))
            for user_dir in sorted(week_dir.iterdir()):
                if not user_dir.is_dir():
                    continue
                meta_file = user_dir / "metadata.json"
                if not meta_file.exists():
                    continue
                with open(meta_file, encoding="utf-8") as f:
                    meta = json.load(f)
                uid = user_dir.name

                history = meta.get("submission_history", [])
                if not history and meta.get("submitted_at"):
                    history = [{
                        "submission_number": 1,
                        "github_url": meta.get("github_url"),
                        "submitted_at": meta.get("submitted_at"),
                        "elapsed_seconds": meta.get("elapsed_seconds"),
                        "elapsed_minutes": meta.get("elapsed_minutes"),
                    }]

                for entry in history:
                    sn = entry.get("submission_number", 1)
                    url = esc(entry.get("github_url"))
                    sat = esc(entry.get("submitted_at"))
                    es = entry.get("elapsed_seconds", 0)
                    em = entry.get("elapsed_minutes", 0)
                    pst = esc(meta.get("personal_start_time"))
                    gst = esc(meta.get("global_start_time"))
                    lines.append(
                        f"INSERT OR IGNORE INTO submissions (user_id, week, submission_number, github_url, submitted_at, elapsed_seconds, elapsed_minutes, personal_start_time, global_start_time) "
                        f"VALUES ({esc(uid)}, {week_num}, {sn}, {url}, {sat}, {es}, {em}, {pst}, {gst});"
                    )
        lines.append("")

    # ===== 4. Evaluations =====
    evaluations_dir = BASE / "evaluations"
    if evaluations_dir.exists():
        lines.append("-- Evaluations")
        for week_dir in sorted(evaluations_dir.iterdir()):
            if not week_dir.is_dir() or not week_dir.name.startswith("week"):
                continue
            week_num = int(week_dir.name.replace("week", ""))
            for eval_file in sorted(week_dir.glob("*.json")):
                with open(eval_file, encoding="utf-8") as f:
                    ev = json.load(f)
                uid = eval_file.stem
                status = ev.get("status", "pending_review")
                scores = ev.get("scores", {})

                if status != "completed" or not scores:
                    # Insert a pending placeholder
                    sn = ev.get("submission_number") or 1
                    lines.append(
                        f"INSERT OR IGNORE INTO evaluations (user_id, week, submission_number, rubric_score, time_rank, time_rank_bonus, total_score, status) "
                        f"VALUES ({esc(uid)}, {week_num}, {sn}, 0, 0, 0, 0, {esc(status)});"
                    )
                    continue

                sn = ev.get("submission_number") or 1
                rubric = scores.get("rubric", 0)
                tr = scores.get("time_rank", 0)
                trb = scores.get("time_rank_bonus", 0)
                total = scores.get("total", 0)
                fb = esc(ev.get("feedback", ""))
                strengths = esc(json.dumps(ev.get("strengths", []), ensure_ascii=False)) if ev.get("strengths") else "NULL"
                improvements = esc(json.dumps(ev.get("improvements", []), ensure_ascii=False)) if ev.get("improvements") else "NULL"
                eat = esc(ev.get("evaluated_at"))

                lines.append(
                    f"INSERT OR IGNORE INTO evaluations (user_id, week, submission_number, rubric_score, time_rank, time_rank_bonus, total_score, feedback, strengths, improvements, status, evaluated_at) "
                    f"VALUES ({esc(uid)}, {week_num}, {sn}, {rubric}, {tr}, {trb}, {total}, {fb}, {strengths}, {improvements}, 'completed', {eat});"
                )
        lines.append("")

    print("\n".join(lines))


if __name__ == "__main__":
    main()
